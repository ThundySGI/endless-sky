# Copyright (c) 2020 MasterOfGrey
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <https://www.gnu.org/licenses/>.

disable mission
	"Hai Rescue: Yeertle Family"
	"Hai Rescue: Ooonem"

event "hr: media retraction"

mission "Hai Reveal: Media Retraction"
	landing
	invisible
	source
		government "Republic" "Syndicate" "Free Worlds" "Neutral"
		attributes "spaceport"
	to offer
		has "event: hr: media retraction"
	on offer
	# Sync reputations for aliases of governments:
		"reputation: Republic that won't enter wormhole" = "reputation: Republic"
		"reputation: Free Worlds that won't enter wormhole" = "reputation: Free Worlds"
		# Make sure the new governments start with appropriate rep:
		"reputation: Elenctic Commune" = 1000
		conversation
			`<CN-12823>`
				decline



event "pirates respond to leaks"
	# Add pirate spawns to Waypoint and Heia Due
	system "Waypoint"
		government "Pirate"
		add fleet "Large Northern Pirates" 3000
		add fleet "Small Northern Pirates" 1000
		add fleet "Large Core Pirates" 3000
		add fleet "Small Core Pirates" 1000
		remove fleet "Small Hai"
		remove fleet "Large Hai"
	system "Heia Due"
		add fleet "Marauder fleet IX" 3000
		add fleet "Large Northern Pirates" 3000
		add fleet "Large Core Pirates" 3000
		add fleet "Anti-Pirate Hai (Wormhole Travel)" 1000



# This gets picked up silently on Hai-home when landing for response 2 - leads to go kill pirates mission with chat on Allhome.
# No longer gets picked up silently due to write-read order style preferences - but may need to be moved back to Response 2 or have multiple versions of this mission when other campaigns exist.
mission "Hai Leaks Response 3"
	name "<NM-673>"
	description "<DS-2667>"
	landing
	source "Hai-home"
	destination "Allhome"
	to offer
		has "Hai Leaks Response 2: done"
	on offer
		conversation
			`<CN-12824>`
			`<CN-12825>`
			choice
				`<CN-12826>`
			`<CN-12827>`
			`<CN-12828>`
			`<CN-12829>`
			`<CN-12830>`
			choice
				`<CN-12831>`
				`<CN-12832>`
					goto "bad news"
			`<CN-12833>`
			`<CN-12834>`
				goto charts
			label "bad news"
			`<CN-12835>`
			label charts
			`<CN-12836>`
			`<CN-12837>`
			`<CN-12838>`
			choice
				`<CN-12706>`
			`<CN-12839>`
			`<CN-12840>`
			`<CN-12841>`
			choice
				`<CN-12842>`
					accept
# If a republic/syndicate campaign gets added this text will need variants.



# Go kill pirates mission with chat on Allhome.
mission "Hai Leaks Response 4"
	autosave
	landing
	name "<NM-674>"
	description "<DS-2668>"
	source "Allhome"
	waypoint "Waypoint"
	destination "Allhome"
	to offer
		has "Hai Leaks Response 3: done"
	on offer
		conversation
			`<CN-12843>`
			`<CN-12844>`
			choice
				`<CN-12845>`
				`<CN-12846>`
			`<CN-12847>`
			choice
				`<CN-12848>`
			`<CN-12849>`
			`<CN-12850>`
			`<CN-12851>`
			`<CN-12852>`
			`<CN-12853>`
			choice
				`<CN-12854>`
					accept
				`<CN-12855>`
					accept
				`<CN-12856>`
					accept
	# Escorts manually defined to have weapons comparatively suitable for disabling, as would be appropriate in a mission where the *hopeful* outcome is a rescue.
	npc
		government "Hai"
		personality escort heroic disables
		fleet
			names "hai"
			cargo 0
			variant
				"Shield Beetle (Six Ion)" 2
				"Shield Beetle (Durable Pulse)" 3
				"Ladybug (Three Ion)" 4
				"Ladybug (Pulse)" 6
	npc
		government "Pirate"
		personality staying disables plunders harvests
		system "Waypoint"
		fleet "Marauder fleet IX" 4
		fleet "Hired Guns" 1
	npc kill
		government "Pirate"
		personality staying target
		system "Waypoint"
		ship "Marauder Leviathan (Weapons)" "Black Lich"
	on visit
		dialog `<DL-559>`
	to complete
		not "Hai Leaks Response 4A: active"
	on complete
		payment 1000000
		event "waypoint pirates vanquished"
		event "hai ladybug available"
		event "humans adopt ladybugs" 20 30
		log `<LG-375>`
		conversation
			branch "saved geocoris"
				has "ship model (all): Geodesic Geocoris"
			`<CN-12857>`
			`<CN-12858>`
			`<CN-12859>`
				goto end
			label "saved geocoris"
			`<CN-12860>`
			`<CN-12861>`
			`<CN-12862>`
			`<CN-12863>`
			label end
			`<CN-12864>`
			branch "saved geocoris2"
				has "ship model (all): Geodesic Geocoris"
			`<CN-12865>`
				decline
			label "saved geocoris2"
			`<CN-12866>`
				decline
	on fail
		dialog `<DL-560>`
	
event "waypoint pirates vanquished"
	# Update pirate and anti-pirate spawns in Waypoint and Heia Due
	system "Waypoint"
		government "Hai"
		add fleet "Anti-Pirate Hai (Wormhole Travel)" 1000
		remove fleet "Marauder fleet IX"
		remove fleet "Anti-Pirate Hai (No Wormhole Travel)"
		remove fleet "Large Northern Pirates"
		remove fleet "Large Core Pirates"
	system "Heia Due"
		remove fleet "Marauder fleet IX"
		remove fleet "Large Northern Pirates"
		remove fleet "Large Core Pirates"

event "hai ladybug available"
	shipyard "Mon Ki i'Hiya Basics"
		add "Ladybug"


# It is impossible to implement a "capture and return npc" mission.
# Once the ship is captured, the mission is completed.
# The NPC is a special ship model used to determine if you managed to get it back safely.
mission "Hai Leaks Response 4A"
	name "<NM-675>"
	description "<DS-2669>"
	landing
	source "Allhome"
	waypoint "Waypoint"
	destination "Allhome"
	to offer
		has "Hai Leaks Response 3: done"
	npc capture
		government "Pirate"
		personality staying marked mute
		system "Waypoint"
		ship "Geodesic Geocoris (Phylactery)" "Phylactery"
		dialog `<DL-561>`
#	on fail
#		dialog `You have failed to recover the Geocoris. This is not critical, but does have long-term consequences. If you want the most complete ending, revert to the autosave or another earlier snapshot of the game.`
# Too hand-holdy for present implementation and content.


# Success means the Geodesic Geocoris may become available to purchase specially later on. Not less than 2 years later.
mission "Hai Leaks Response 4B"
	landing
	invisible
	source "Allhome"
	to offer
		has "ship model (all): Geodesic Geocoris"
	on offer
		log `<LG-376>`
		event "returned geocoris" 730
		fail

event "returned geocoris"

ship "Geodesic Geocoris"
	plural "Geodesic Geocoris"
	sprite "ship/geodesic geocoris"
	thumbnail "thumbnail/geodesic geocoris"
	attributes
		category "Utility"
		"cost" 23540000
		"shields" 26600
		"hull" 7100
		"required crew" 27
		"bunks" 48
		"mass" 955
		"drag" 21.3
		"heat dissipation" 0.4
		"fuel capacity" 800
		"cargo space" 1003
		"outfit space" 555
		"weapon capacity" 250
		"engine capacity" 134
		"energy capacity" 5200
		"shield generation" 6.0
		"shield energy" 8.8
		"hull repair rate" 0.8
		"hull energy" 0.8
		"hull heat" 1.2
		"integrated control systems" -1
		"integrated systems core" 1
		weapon
			"blast radius" 400
			"shield damage" 4000
			"hull damage" 2000
			"hit force" 6000
	outfits
		"Chameleon Anti-Missile" 2
		"Quad Blaster Turret" 2
		"Pulse Turret" 2
		
		"Quantum Keystone"
		"Boulder Reactor" 2
		"Liquid Helium Cooler"
		"Security Station" 2
		"Pulse Rifle" 30

		"A525 Atomic Steering"
		`<CN-7916>`
		"AR120 Reverse Thruster" 2
		Hyperdrive

	turret 0 -82.5 "Pulse Turret"
	turret -95 -17 "Chameleon Anti-Missile"
	turret 95 -17 "Chameleon Anti-Missile"
	turret -29 3 "Quad Blaster Turret"
	turret 29 3 "Quad Blaster Turret"
	turret 0 91.5 "Pulse Turret"
	engine -95 41.5 0.9
	engine 95 41.5 0.9
	engine 1 154.5 0.9
	leak "leak" 40 50
	leak "flame" 40 80
	leak "big leak" 70 30
	explode "tiny explosion" 50
	explode "small explosion" 50
	explode "medium explosion" 50
	explode "large explosion" 50
	explode "huge explosion" 20
	"final explode" "final explosion large"
	description "<DS-2670>"
	
ship "Geodesic Geocoris" "Geodesic Geocoris (Phylactery)"
	outfits
		"Electron Turret" 3
		"Chameleon Anti-Missile" 2
		"AR120 Reverse Thruster" 2
		"Boulder Reactor"
		"Hai Ravine Batteries"
		"Outfits Expansion"
		"Large Heat Shunt"
		"Quantum Keystone"
		"Pulse Rifle" 14
		`<CN-7911>`
		`<CN-1079>`
		"Jump Drive"
		Hyperdrive
		"Failed Control System"
	turret "Electron Turret"
	turret "Electron Turret"
	turret "Chameleon Anti-Missile"
	turret "Chameleon Anti-Missile"
	turret "Electron Turret"
	description "<DS-2671>"


# The spike in interest leads to ladybugs appearing in the Hai Merchant (Human) fleets.
event "humans adopt ladybugs"
	fleet "Small Hai Merchant (Human)"
		add variant 6
			"Freighter (Hai)"
			"Ladybug (Pulse)"
		add variant 6
			"Freighter (Hai)"
			"Ladybug (Three Ion)"
		add variant 3
			"Mule (Hai Engines)"
			"Ladybug (Pulse)"
		add variant 3
			"Mule (Hai Engines)"
			"Ladybug (Three Ion)"
	fleet "Large Hai Merchant (Human)"
		add variant 20
			"Water Bug" 2
			"Ladybug (Pulse)"
		add variant 20
			"Water Bug" 2
			"Ladybug (Three Ion)"
		add variant 3
			"Freighter (Hai)" 2
			"Ladybug"
		add variant 10
			"Freighter (Hai)" 2
			"Ladybug (Pulse)"
		add variant 10
			"Freighter (Hai)" 3
			"Ladybug (Pulse)"
		add variant 4
			"Behemoth (Hai)"
			"Ladybug (Pulse)" 2
		add variant 4
			"Behemoth (Hai)"
			"Ladybug (Pulse)"
			"Ladybug (Three Ion)"
		add variant 4
			"Behemoth (Hai)"
			"Ladybug (Three Ion)" 2
		add variant 4
			"Hauler III (Hai)"
			"Water Bug"
			"Headhunter (Hai)" 1
			"Ladybug (Three Ion)"
		add variant 2
			"Container Transport (Hai)"
			"Grasshopper"
			"Ladybug (Pulse)"
		add variant 1
			"Container Transport (Hai)"
			"Ladybug (Pulse)" 2


mission "Hai Leaks Response 5"
	landing
	name "<NM-676>"
	description "<DS-2672>"
	source "Allhome"
	clearance
	destination "Hai-home"
	to offer
		has "Hai Leaks Response 4: done"
	on complete
		event "allhome reinforced" 1
		conversation
			`<CN-12867>`
			`<CN-12868>`

event "allhome reinforced"
	system "Heia Due"
		add fleet "Anti-Pirate Hai (No Wormhole Travel)" 600


mission "Hai Leaks Response 5B"
	landing
	name "<NM-677>"
	description "<DS-2673>"
	source "Hai-home"
	clearance
	to offer
		has "Hai Leaks Response 5: done"
		not "Hai Leaks Response 6: offered"
	to complete
		never



# This non-landing mission allows you to take the game-play pause and go do other stuff if you need before getting too deeply involved in the story.
mission "Hai Leaks Response 6"
	name "<NM-678>"
	description "<DS-2674>"
	autosave
	source "Hai-home"
	destination "Hai-home"
	clearance
	to offer
		has "event: allhome reinforced"
	on offer
		event "secret mountaintop"
		event "role-play fleet deception"
		event "slightly lost" 10
		# Hai like you a lot now, and as a result, you have permanent access to Hai-home:
		"reputation: Hai" >?= 100
		fail "Hai Leaks Response 5B"
		log `<LG-377>`
		conversation
			`<CN-12869>`
			choice
				`<CN-12870>`
				`<CN-12871>`
				`<CN-12872>`
			`<CN-12873>`
			choice
				`<CN-12874>`
					goto next
				`<CN-12875>`
					goto about
				`<CN-12876>`
			`<CN-12877>`
			label about
			`<CN-12878>`
			choice
				`<CN-12879>`
				`<CN-12880>`
					goto next
			`<CN-12881>`
			`<CN-12882>`
			label next
			`<CN-12883>`
			`<CN-12884>`
			`<CN-12885>`
			choice
				`<CN-648>`
				`<CN-12886>`
			`<CN-12887>`
			`<CN-12888>`
			`<CN-12889>`
			choice
				`<CN-133>`
			`<CN-12890>`
			`<CN-12891>`
			`<CN-12892>`
			`<CN-12893>`
			choice
				`<CN-12894>`
					goto "do things"
				`<CN-12895>`
			`<CN-12896>`
			`<CN-12897>`
			label "do things"
			`<CN-12898>`
			branch "about that"
				"hai slave prereq" >= 1
			choice
				`<CN-12899>`
			`<CN-12900>`
				goto mean
			label "about that"
			`<CN-12901>`
			`<CN-12902>`
			`<CN-12903>`
			`<CN-12904>`
			label mean
			choice
				`<CN-12905>`
					accept
				`<CN-12906>`
			`<CN-12907>`
				accept
	on visit
		dialog "<DL-562>"
	to complete
		"hai slave prereq" >= 3
		has "Hai Rescue: Gipeep: offered"
	on complete
		log `<LG-378>`

event "secret mountaintop"
	# Ensure Mountaintop exists so the next mission can trigger
	# The system is redefined from scratch here to insulate against map file changes messing with later events (see issue #7605 which this fixes)
	system "Ultima Thule"
		government "Uninhabited"
		object
			sprite star/f0
			period 10
		object
			sprite planet/desert5
			distance 200
			period 22.3606
		object
			sprite planet/europa-b
			distance 403.41
			period 64.0560
		object
			sprite planet/desert7-b
			distance 824.9
			period 187.301
		object
			sprite planet/gas1
			distance 1706.99
			period 557.553
			object
				sprite planet/ice8-b
				distance 216
				period 11.1964
		object "Wormhole Alpha"
			sprite planet/wormhole
			distance 4208.63
			period 2158.5
		object
			distance 4208.63
			period 2158.5
			object Mountaintop
				sprite "effect/flotsam yottrite"
				distance 315
				period 31.1964
	planet Mountaintop
		government "Unknown"
		attributes "requires: neverallowed"
		# Placeholder description; you can't actually land.
		description `<DS-2675>`
		"required reputation" 1000
		bribe 0



mission "Hai Leaks Response 7"
	landing
	invisible
	source
		government "Republic" "Free Worlds" "Syndicate" "Neutral" "Independent" "Hai"
		not attributes "uninhabited"
	to offer
		has "Hai Leaks Response 6: active"
		"hai slave prereq" >= 3
		has "Hai Rescue: Gipeep: offered"
	on offer
		conversation
			`<CN-12908>`
				decline

event "slightly lost"

event "role-play fleet deception"
	system "Ultima Thule"
		add fleet "Anti-Pirate Hai (Wormhole Travel)" 2000
	system "Rajak"
		add fleet "Anti-Pirate Hai (Wormhole Travel)" 1000
		
