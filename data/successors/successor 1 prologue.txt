# Copyright (c) 2024 by Daeridanii
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <https://www.gnu.org/licenses/>.

mission "Successors: Entering the Scar"
	invisible
	landing
	to complete
		never
	to fail
		has "Successors: Safe at Last: failed"
	on enter
		system
			attributes "predecessor"
		fail
		dialog
			`<CN-17745>`

mission "Successors: Safe at Last"
	invisible
	landing
	to complete
		never
	to fail
		has "Successors: First Contact 1: offered"
	on enter "Myruet-Kvelq"
		fail
		dialog
			`<CN-17746>`

mission "Successors: First Contact 1"
	landing
	name "<NM-882>"
	description "<DS-3346>"
	source
		attributes "successor"
		not attributes "uninhabited"
	destination "Staja-Kella-Oa"
	clearance
	to fail
		has "Successors: Unified Defense: offered"
	on offer
		conversation
			`<CN-17747>`
			`<CN-17748>`
			`<CN-17749>`
			`<CN-17750>`
			choice
				`<CN-515>`
					goto map
				`<CN-8008>`
					goto introduce
				`<CN-8009>`
					goto introduce
				`<CN-8011>`
			`<CN-17751>`
				die
			label introduce
			`<CN-17752>`
			label map
			`<CN-17753>`
			`<CN-17754>`
			choice
				`<CN-17755>`
				`<CN-17756>`
					goto refused
			action
				log "<LG-496>"
			`<CN-17757>`
				accept
			label refused
			action
				log "<LG-497>"
			`<CN-17758>`
				flee

	npc accompany save
		government "House Sioeora"
		personality timid launching escort
		ship "Stolsaqra (Mission Escort)" "Kijet-i-khisa"
		ship "Stolsaqra (Mission Escort)" "Iyiq-sora"
		ship "Stolsaqra (Mission Escort)" "Seqra-saqra"

	on fail
		dialog `<DL-720>`

	on visit
		conversation
			`<CN-17759>`
				launch

	on complete
		event "label successor space"
		event "successors: first contact wait" 8
		log `<LG-498>`
		log "Factions" "Successors" `<LG-499>`
		"reputation: Successor" += 1
		"reputation: House Chydiyi" += 1
		"reputation: House Myurej" += 1
		"reputation: House Sioeora" += 1
		conversation
			`<CN-17760>`
			`<CN-17761>`
			`<CN-17762>`
			choice
				`<CN-17763>`
				`<CN-17764>`
			`<CN-17765>`
			choice
				`<CN-2851>`
				`<CN-17766>`
			`<CN-17767>`
			label questions
			choice
				`<CN-17768>`
					goto "what now"
				`<CN-8046>`
					to display
						not "Successors: language"
					goto language
				`<CN-17769>`
					to display
						has "Successors: history"
						not "Successors: ripped"
					goto ripped
				`<CN-17770>`
					to display
						not "Successors: history"
					goto history
				`<CN-17771>`
					to display
						has "Successors: language"
						not "Successors: changed"
					goto changed
				`<CN-17772>`
					to display
						not "Successors: house"
					goto house
			label language
			`<CN-17773>`
				to display
					has "Successors: history"
			action
				set "Successors: language"
				set "Successors: history"
			`<CN-17774>`
				goto questions
			label "language short"
			action
				set "Successors: language"
			`<CN-17775>`
				goto questions
			label changed
			action
				set "Successors: changed"
			`<CN-17776>`
				goto questions
			label ripped
			action
				set "Successors: ripped"
			`<CN-17777>`
				goto questions
			label history
			action
				set "Successors: history"
			`<CN-17773>`
			choice
				`<CN-17768>`
					goto "what now"
				`<CN-17778>` # This follow up question reverts to "How do you know my language?" if it isn't immediately asked
					to display
						not "Successors: language"
					goto "language short"
				`<CN-17769>`
					goto ripped
				`<CN-17772>`
					to display
						not "Successors: house"
					goto house
			label house
			action
				set "Successors: house"
			`<CN-17779>`
				goto questions
			label "what now"
			action
				clear "Successors: changed"
				clear "Successors: history"
				clear "Successors: house"
				clear "Successors: language"
				clear "Successors: ripped"
			`<CN-17780>`
			`<CN-17781>`

mission "Successors: First Contact 2 Prompt"
	landing
	name "<NM-39>"
	description `<DS-3347>`
	source
		attributes "successor"
		not attributes "uninhabited"
		not planet "Staja-Kella-Oa"
	destination "Staja-Kella-Oa"
	to offer
		has "event: successors: first contact wait"
		not "Successors: First Contact 2: offered"
	to fail
		has "Successors: Unified Defense: offered"
	on offer
		event "successors: tardy for sioeora" 14
		conversation
			`<CN-17782>`
			`<CN-17783>`
			`<CN-17784>`
				accept

mission "Successors: First Contact 2"
	landing
	invisible
	source "Staja-Kella-Oa"
	to offer
		has "event: successors: first contact wait"
	to fail
		has "Successors: Unified Defense: offered"
	on offer
		log "People" "Sieasej" "<LG-500>"
		conversation
			`<CN-17785>`
			`<CN-17786>`
			choice
				`<CN-17787>`
					goto inside
				`<CN-14188>`
			`<CN-17788>`
			choice
				`<CN-17787>`
					goto inside
				`<CN-17789>`
			`<CN-17790>`
			choice
				`<CN-17791>`
			label inside
			`<CN-17792>`
			`<CN-17793>`
			`<CN-17794>`
			branch "tardy"
				has "event: successors: tardy for sioeora"
			`<CN-17795>`
				goto greet
			label tardy
			`<CN-17796>`
			label greet
			choice
				`<CN-515>`
					goto request
				`<CN-17797>`
					goto introduce
				`<CN-17798>`
					to display
						has "event: successors: tardy for sioeora"
					goto "apologize tardiness"
			label introduce
			`<CN-17799>`
				goto request
			label "apologize tardiness"
			`<CN-17800>`
			label request
			`<CN-17801>`
			choice
				`<CN-515>`
				`<CN-17802>`
				`<CN-17803>`
					goto gift
				`<CN-17804>`
					goto rude
			label task
			`<CN-17805>`
			choice
				`<CN-14529>`
					goto accepted
				`<CN-17806>`
					goto rejected
			label gift
			`<CN-17807>`
			choice
				`<CN-14529>`
					goto accepted
				`<CN-17806>`
					goto rejected
			label rude
			`<CN-17808>`
			choice
				`<CN-17809>`
				`<CN-17810>`
					goto rejected
			`<CN-17800>`
				goto task
			label accepted
			action
				log "<LG-501>"
			`<CN-17811>`
				decline
			label rejected
			action
				log "<LG-502>"
				set "Successors: First Contact 2: rejected"
				"reputation: House Sioeora" <?= 0
			`<CN-17812>`
			`<CN-17813>`
			`<CN-17814>`
				flee

mission "Successors: First Contact 3"
	name "<NM-883>"
	description `<DS-3348>`
	source "Staja-Kella-Oa"
	to offer
		has "event: successors: first contact wait"
		not "Successors: First Contact 2: rejected"
	to fail
		has "Successors: Unified Defense: offered"
	deadline 30
	stopover "Raaqa-Uur-Kaav"
	destination "Staja-Kella-Oa"
	passengers 1
	cargo "Animal Transport Container" 1
	blocked `<BL-104>`
	substitutions
		"<tranq h2h>" "Pug staff"
		"<tranq h2h>" "Heliarch staff"
			has "outfit: Enforcer Riot Staff"
		"<a tranq h2h long>" "a Pug Peacekeeping Staff"
		"<a tranq h2h long>" "an Enforcer Riot Staff"
			has "outfit: Enforcer Riot Staff"
	on offer
		conversation
			`<CN-17815>`
			choice
				`<CN-17816>`
					goto task
				`<CN-17817>`
			`<CN-17818>`
			`<CN-17819>`
			`<CN-17820>`
			label task
			`<CN-17821>`
			label questions
			choice
				`<CN-17822>`
					goto embark
				`<CN-17823>`
					to display
						has "Successors: knowledge"
						not "Successors: jump drives"
					goto "jump drives"
				`<CN-17824>`
					to display
						has "Successors: jump drives"
						not "Successors: warning"
					goto warning
				`<CN-17825>`
					to display
						not "Successors: kijra-pet"
					goto kijra-pet
				`<CN-17826>`
					to display
						not "Successors: knowledge"
					goto knowledge
				`<CN-17827>`
					to display
						not "Successors: you okay"
					goto "you okay"
				`<CN-17828>`
					to display
						not "Successors: watch out"
					goto "watch out"
			label kijra-pet
			action
				set "Successors: kijra-pet"
			`<CN-17829>`
				goto questions
			label knowledge
			action
				set "Successors: knowledge"
			`<CN-17830>`
				goto questions
			label "jump drives"
			action
				set "Successors: jump drives"
			`<CN-17831>`
				goto questions
			label warning
			action
				set "Successors: warning"
			`<CN-17832>`
				goto questions
			label "you okay"
			action
				set "Successors: you okay"
			`<CN-17833>`
				goto questions
			label "watch out"
			action
				set "Successors: watch out"
			`<CN-17834>`
				goto questions
			label embark
			action
				clear "Successors: jump drives"
				clear "Successors: kijra-pet"
				clear "Successors: knowledge"
				clear "Successors: warning"
				clear "Successors: watch out"
				clear "Successors: you okay"
			`<CN-17835>`
				accept
	on stopover
		conversation
			`<CN-17836>`
			`<CN-17837>`
			branch "retrieve tranqs"
				or
					has "outfit (flagship installed): Enforcer Riot Staff"
					has "outfit (flagship installed): Pug Peacekeeping Staff"
			`<CN-17838>`
				goto approach
			label "retrieve tranqs"
			`<CN-17839>`
			label approach
			choice
				`<CN-17840>`
					goto encounter
				`<CN-17841>`
			`<CN-17842>`
			label encounter
			`<CN-17843>`
			choice
				`<CN-17844>`
					goto tranq
					to display
						or
							has "outfit (flagship installed): Enforcer Riot Staff"
							has "outfit (flagship installed): Pug Peacekeeping Staff"
				`<CN-17845>`
					goto net
				`<CN-17846>`
					goto lure
			label tranq
			branch tranqed
				random < 70
			`<CN-17847>`
				goto escape
			label tranqed
			`<CN-17848>`
				goto "bring tranq"
			label net
			`<CN-17849>`
				goto escape
			label lure
			`<CN-17850>`
			choice
				`<CN-17851>`
				`<CN-17852>`
					goto "tranq friends"
					to display
						or
							has "outfit (flagship installed): Enforcer Riot Staff"
							has "outfit (flagship installed): Pug Peacekeeping Staff"
				`<CN-17853>`
					goto "net friends alarmed"
			action
				set "Successors FC3: nonviolent kijra-pet capture"
			`<CN-17854>`
			`<CN-17855>`
				goto ambush
			label "tranq friends"
			`<CN-17856>`
				goto "bring tranq"
			label "net friends alarmed"
			`<CN-17857>`
				goto escape
			label "bring tranq"
			`<CN-17858>`
				goto ambush
			label escape
			choice
				`<CN-17859>`
			`<CN-17860>`
			choice
				`<CN-17861>`
				`<CN-17862>`
					goto "shoot ambush"
			`<CN-17863>`
				goto ambush
			label "shoot ambush"
			`<CN-17864>`
			label ambush
			`<CN-17865>`
			choice
				`<CN-17866>`
				`<CN-17867>`
					goto shoot
				`<CN-17868>`
					to display
						"flagship base attribute: turret mounts" > "flagship attribute: turret mounts"
						"flagship crew" > ( "flagship required crew" - 1 )
					goto "ship shoot"
				`<CN-17869>`
					goto release
			`<CN-17870>`
				die
			label shoot
			`<CN-17871>`
				goto successful
			label "ship shoot"
			`<CN-17872>`
				goto successful
			label release
			branch "release friends"
				has "Successors FC3: nonviolent kijra-pet capture"
			action
				set "Successors FC3: released kijra-pet"
			`<CN-17873>`
				goto released
			label "release friends"
			action
				set "Successors FC3: released kijra-pet"
				set "Successors FC3: friend to animals" # Nonviolent capture AND released at first opportunity
			`<CN-17874>`
				goto released
			label successful
			`<CN-17875>`
			`<CN-17876>`
			choice
				`<CN-17877>`
					goto "take off"
				`<CN-17878>`
				`<CN-17879>`
					goto "better late than never"
			action
				set "Successors FC3: captured kijra-pet"
			`<CN-17880>`
				goto end
			label "take off"
			action
				set "Successors FC3: captured kijra-pet"
			`<CN-17881>`
				goto end
			label "better late than never"
			action
				set "Successors FC3: released kijra-pet"
			`<CN-17882>`
				goto end
			label released
			`<CN-17883>`
			choice
				`<CN-17884>`
					goto "back alive"
				`<CN-17885>`
			`<CN-17886>`
				goto "released 2"
			label "back alive"
			`<CN-17887>`
			label "released 2"
			`<CN-17888>`
			`<CN-17889>`
			label end

	on fail
		dialog `<DL-721>`
		"reputation: House Sioeora" = -999
		"reputation: Successor" <?= 0
		"reputation: House Chydiyi" <?= 0
		"reputation: House Myurej" <?= 0

	on complete
		conversation
			branch capture
				has "Successors FC3: captured kijra-pet"
			label release
			action
				"reputation: House Sioeora" <?= 0
				event "successors: released kijra-pet wait" 32
				log "<LG-503>"
			`<CN-17890>`
			`<CN-17891>`
			choice
				`<CN-17892>`
				`<CN-17893>`
			`<CN-17894>`
			`<CN-17895>`
				goto exit

			label capture
			action
				set "known to the successors"
				set "language: Successor"
				set "successors sioeora patron"
				event "successors: trust 1"
				"reputation: Successor" += 1
				"reputation: House Chydiyi" += 1
				"reputation: House Myurej" += 1
				"reputation: House Sioeora" += 1
				"reputation: House Aqrabe" += 2
				"reputation: House Seineq" += 2
				"reputation: People's Houses" += 2
				log "<LG-504>"
			`<CN-17896>`
			`<CN-17897>`
			choice
				`<CN-13215>`
				`<CN-133>`
			`<CN-17898>`
			`<CN-17899>`
			`<CN-17900>`
			choice
				`<CN-6859>`
			`<CN-17901>`
			`<CN-17902>`
			label questions
			choice
				`<CN-17903>`
					to display
						not "Successors: others"
						not "Successors: animal"
					goto end
				`<CN-5763>`
					to display
						or
							has "Successors: others"
							has "Successors: animal"
					goto end
				`<CN-17904>`
					to display
						not "Successors: others"
					goto others
				`<CN-17905>`
					to display
						not "Successors: animal"
					goto animal
			label others
			action
				set "Successors: others"
			`<CN-17906>`
				goto questions
			label animal
			action
				set "Successors: animal"
			`<CN-17907>`
				goto questions
			label end
			action
				clear "Successors: animal"
				clear "Successors: others"
			`<CN-17908>`
			label exit

mission "Successors: Kaatrij Monoglot Prompt"
	landing
	invisible
	to offer
		has "event: successors: released kijra-pet wait"
		not "Successors: First Contact 3: failed"
		and
			not "language: Hai"
			not "language: Coalition"
	to fail
		has "Successors: Unified Defense: offered"
	on offer
		conversation
			`<CN-17909>`
				decline

mission "Successors: First Contact 3: Fix Friend to Animals"
	landing
	invisible
	to offer
		# Impossible to detect if the stopover happened, so patch the conditions after the mission completes
		has "Successors: First Contact 3: done"
		has "Successors FC3: nonviolent kijra-pet capture"
		not "Successors FC3: released kijra-pet"
		not "Successors FC3: captured kijra-pet"
	on offer
		set "Successors FC3: released kijra-pet"
		set "Successors FC3: friend to animals"
		fail

mission "Successors: Kaatrij First Contact 1"
	landing
	clearance
	infiltrating
	name "<NM-884>"
	description "<DS-3349>"
	destination "Raaqa-Puan-Uuoru"
	to offer
		has "event: successors: released kijra-pet wait"
		not "Successors: First Contact 3: failed"
		or
			has "language: Hai"
			has "language: Coalition"
	to fail
		has "Successors: Unified Defense: offered"
	substitutions
		"<coalition ally>" "Heliarchy"
		"<coalition ally>" "Lunarium"
			has "joined the lunarium"
	on offer
		conversation
			branch "was monoglot"
				has "Successors: Kaatrij Monoglot Prompt: offered"
			branch hai
				has "language: Hai"
			`<CN-17910>`
				goto "message coalition"
			label hai
			`<CN-17911>`
				goto "message hai"

			label "was monoglot"
			branch "hai monoglot"
				has "language: Hai"
			`<CN-17912>`
			choice
				`<CN-17913>`
				`<CN-6356>`
					defer
				`<CN-17914>`
					decline
			`<CN-17915>`
				goto "message coalition"
			label "hai monoglot"
			`<CN-17916>`
			choice
				`<CN-17913>`
				`<CN-6356>`
					defer
				`<CN-17914>`
					decline
			`<CN-17917>`
				goto "message hai"
			label "message coalition"
			`<CN-17918>`
				goto end
			label "message hai"
			`<CN-17919>`
			label end
			`<CN-17920>`
				accept
	on complete
		conversation
			`<CN-17921>`
			choice
				`<CN-800>`
			`<CN-17922>`
			choice
				`<CN-17923>`
				`<CN-835>`
					goto premature
			`<CN-17924>`
			choice
				`<CN-17925>`
				`<CN-835>`
					goto premature
			`<CN-17926>`
			choice
				`<CN-17927>`
				`<CN-835>`
					goto premature
			`<CN-17928>`
			`<CN-17929>`
			choice
				`<CN-17930>`
				`<CN-678>`
			`<CN-17931>`
			choice
				`<CN-17932>`
					goto kijran
				`<CN-17933>`
					to display
						not "language: Successor"
					goto communicate
			label questions
			choice
				`<CN-17933>`
					to display
						not "language: Successor"
					goto communicate
				`<CN-17934>`
					to display
						has "language: Successor"
					goto end
				`<CN-17935>`
					to display
						has "language: Successor"
						not "Successors: sioeora"
					goto sioeora
				`<CN-17936>`
					to display
						has "language: Successor"
						not "Successors: saajret"
					goto saajret
				`<CN-17937>`
					to display
						not "Successors: kijran"
					goto kijran
				`<CN-17936>`
					to display
						has "language: Successor"
						not "Successors: kijran"
			label kijran
			action
				set "Successors: kijran"
			`<CN-17938>`
				goto questions
			label communicate
			`<CN-17939>`
			`<CN-17940>`
			`<CN-17941>`
			choice
				`<CN-6859>`
			action
				set "language: Successor"
			`<CN-17942>`
			`<CN-17943>`
				goto questions
			label sioeora
			action
				set "Successors: sioeora"
			`<CN-17944>`
				goto questions
			label saajret
			action
				log "People" "Saajret, of Somber Sejra" "<LG-505>"
				set "Successors: saajret"
			`<CN-17945>`
				goto questions
			label premature
			`<CN-17946>`
				flee
			label end
			`<CN-17947>`
			`<CN-17948>`
			action
				clear "Successors: kijran"
				clear "Successors: saajret"
				clear "Successors: sioeora"
				log "<LG-506>"
				set "known to the successors"
				set "successors kaatrij patron"
				event "successors: trust 1"
				"reputation: Successor" += 1
				"reputation: House Chydiyi" += 1
				"reputation: House Myurej" += 1
				"reputation: House Aqrabe" += 2
				"reputation: House Kaatrij" += 2
				"reputation: House Seineq" += 2
				"reputation: People's Houses" += 2

mission "Successors: Trusted"
	landing
	name "<NM-885>"
	description "<DS-3350>"
	source
		attributes "successor"
		not attributes "quiet" "crime" "uninhabited"
	destination "Aava-Aasa-Khora"
	to offer
		has "language: Successor"
		"successor jobs" >= 10
	to fail
		has "Successors: Unified Defense: offered"
	substitutions
		"<successor patron>" "Sioeora"
		"<successor patron>" "Kaatrij"
			has "successors kaatrij patron"
		"<successor opponent>" "Kaatrij"
		"<successor opponent>" "Sioeora"
			has "successors kaatrij patron"
	on offer
		"reputation: Old Houses" += 1
		"reputation: New Houses" += 1
		conversation
			`<CN-17949>`
			`<CN-17950>`
			choice
				`<CN-17951>`
					accept
				`<CN-17952>`
			`<CN-17953>`
				accept
	on complete
		set "license: Successor"
		"reputation: Successor" += 1
		"reputation: House Chydiyi" += 1
		set "trusted by the successors"
		event "successors: trust 2"
		log "<LG-507>"
		log "Factions" "Successors" `<LG-508>`
		conversation
			`<CN-17954>`
			`<CN-17955>`
			`<CN-17956>`
			`<CN-17957>`
			label questions
			choice
				`<CN-17822>`
					goto start
				`<CN-17958>`
					to display
						not "Successors: explain"
					goto explain
				`<CN-17959>`
					to display
						not "Successors: sioeora"
					goto sioeora
				`<CN-7220>`
					to display
						not "Successors: about you"
					goto "about you"
			label explain
			action
				set "Successors: explain"
			`<CN-17960>`
				goto questions
			label sioeora
			action
				set "Successors: sioeora"
			branch "sioeora opposed"
				has "successors kaatrij patron"
			`<CN-17961>`
				goto "sioeora choice"
			label "sioeora opposed"
			`<CN-17962>`
			label "sioeora choice"
			choice
				`<CN-17963>`
					goto start
				`<CN-17964>`
					to display
						not "Successors: explain"
					goto explain
				`<CN-7220>`
					to display
						not "Successors: about you"
					goto "about you"
			label "about you"
			action
				set "Successors: about you"
			`<CN-17965>`
			choice
				`<CN-17966>`
					goto start
				`<CN-17959>`
					to display
						not "Successors: sioeora"
					goto sioeora
			label start
			`<CN-17967>`
			`<CN-17968>`
			branch kaatrij
				has "successors kaatrij patron"
			`<CN-17969>`
			`<CN-17970>`
			`<CN-17971>`
			`<CN-17972>`
			`<CN-17973>`
			`<CN-17974>`
			`<CN-17975>`
			choice
				`<CN-505>`
					goto silent
				`<CN-17976>`
					goto no
			label kaatrij
			`<CN-17969>`
			`<CN-17977>`
			`<CN-17971>`
			`<CN-17978>`
			`<CN-17973>`
			`<CN-17979>`
			`<CN-17975>`
			choice
				`<CN-505>`
					goto silent
				`<CN-17976>`
					goto no
			label no
			branch "no kaatrij"
				has "successors kaatrij patron"
			`<CN-17980>`
			`<CN-17981>`
			`<CN-17982>`
				goto license
			label "no kaatrij"
			`<CN-17983>`
			`<CN-17984>`
			`<CN-17985>`
				goto license
			label silent
			`<CN-17986>`
			label license
			scene "outfit/successor license"
			`<CN-17987>`
			`<CN-17988>`
			`<CN-17989>`
			choice
				`<CN-17990>`
				`<CN-17991>`
					goto yours
			`<CN-17992>`
				goto end
			label yours
			`<CN-17993>`
			label end
			action
				clear "Successors: aboutyou"
				clear "Successors: explain"
				clear "Successors: sioeora"
			`<CN-17994>`
